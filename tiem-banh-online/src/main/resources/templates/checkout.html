<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Thanh Toán Đơn Hàng - Tiệm Bánh Ngon</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" th:href="@{/css/custom.css}">
    <style>
        /* CSS bổ sung nếu cần */
        .order-summary-item img {
            max-width: 50px;
            height: 50px; /* Đặt chiều cao cố định */
            object-fit: cover; /* Đảm bảo ảnh không bị méo và fill */
        }
        .required-field::after { content: " *"; color: red; }
        .card-header { background-color: #f8f9fa; /* Màu nền nhẹ cho header card */ }
        /* Định dạng cho tiền tệ */
        .currency {
             white-space: nowrap; /* Ngăn không xuống dòng */
        }
        /* Bỏ ký hiệu tiền tệ tự động bằng CSS đi nếu bạn thêm nó trong th:text */
        /* .currency::after {
            content: ' ₫';
            margin-left: 2px;
        } */
    </style>
</head>
<body class="d-flex flex-column min-vh-100 bg-light"> <!-- Thêm bg-light cho nền -->

    <!-- Include Header -->
    <div th:replace="~{fragments/header :: header}"></div>

    <main class="container my-4 flex-grow-1">
        <h1 class="mb-4 text-center display-6">Thanh Toán</h1>

        <!-- Hiển thị thông báo lỗi chung từ Controller (nếu có) -->
        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show small" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i><span th:text="${errorMessage}"></span>
            <button type="button" class="btn-close btn-sm" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <!-- Trường hợp giỏ hàng trống (Kiểm tra kỹ null) -->
        <div th:if="${cart == null or cart.itemList == null or cart.itemList.isEmpty()}" class="alert alert-warning text-center my-5">
             <i class="bi bi-cart-x fs-1 d-block mb-3"></i>
            <p class="lead">Giỏ hàng của bạn đang trống.</p>
            <a th:href="@{/products}" class="btn btn-primary"><i class="bi bi-arrow-left me-1"></i> Quay lại mua sắm</a>
        </div>

        <!-- Form Checkout và Tóm tắt (Chỉ hiển thị khi giỏ hàng hợp lệ) -->
        <form th:if="${cart != null and cart.itemList != null and !cart.itemList.isEmpty()}"
              th:action="@{/checkout/place-order}"
              method="post"
              th:object="${orderDto}"
              class="needs-validation" novalidate>

            <!-- CSRF Token -->
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
             <!-- Input ẩn cho phương thức thanh toán COD -->
             <input type="hidden" th:field="*{paymentMethod}" value="COD" />

            <div class="row g-4">

                <!-- === Cột trái: Thông tin giao hàng === -->
                <div class="col-lg-7">
                    <div class="card shadow-sm mb-3 mb-lg-0">
                        <div class="card-header py-3">
                            <h4 class="mb-0">Thông Tin Giao Hàng</h4>
                        </div>
                        <div class="card-body">
                            <!-- Hiển thị lỗi validation tổng thể của Form -->
                            <div th:if="${#fields.hasGlobalErrors()}" class="alert alert-danger small p-2 mb-3" role="alert">
                                <p class="mb-0" th:each="err : ${#fields.globalErrors()}" th:text="${err}"></p>
                            </div>

                            <!-- Tên người nhận -->
                            <div class="mb-3">
                                <label for="recipientName" class="form-label required-field">Họ và tên người nhận</label>
                                <input type="text" class="form-control" id="recipientName" th:field="*{recipientName}" required
                                       th:classappend="${#fields.hasErrors('recipientName')} ? 'is-invalid' : ''">
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('recipientName')}" th:errors="*{recipientName}"></div>
                            </div>

                            <!-- Số điện thoại -->
                            <div class="mb-3">
                                <label for="recipientPhone" class="form-label required-field">Số điện thoại</label>
                                <input type="tel" class="form-control" id="recipientPhone" th:field="*{recipientPhone}" required pattern="^(\+84|0)\d{9,10}$"
                                       th:classappend="${#fields.hasErrors('recipientPhone')} ? 'is-invalid' : ''">
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('recipientPhone')}" th:errors="*{recipientPhone}"></div>
                            </div>

                            <!-- Địa chỉ giao hàng -->
                            <div class="mb-3">
                                <label for="shippingAddress" class="form-label required-field">Địa chỉ giao hàng</label>
                                <textarea class="form-control" id="shippingAddress" rows="3" th:field="*{shippingAddress}" required
                                          th:classappend="${#fields.hasErrors('shippingAddress')} ? 'is-invalid' : ''"></textarea>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('shippingAddress')}" th:errors="*{shippingAddress}"></div>
                                <small class="form-text text-muted">Nhập chi tiết số nhà, tên đường, phường/xã, quận/huyện, tỉnh/thành phố.</small>
                            </div>

                             <!-- Ghi chú -->
                            <div class="mb-0">
                                <label for="notes" class="form-label">Ghi chú (tùy chọn)</label>
                                <textarea class="form-control" id="notes" rows="2" th:field="*{notes}"></textarea>
                            </div>

                        </div> <!-- End card-body Shipping -->
                    </div> <!-- End card Shipping -->
                </div> <!-- End Col Thông tin giao hàng -->


                <!-- === Cột phải: Tóm tắt đơn hàng và thanh toán === -->
                <div class="col-lg-5">
                    <div class="card shadow-sm">
                        <div class="card-header py-3">
                             <h4 class="mb-0 d-flex justify-content-between align-items-center">
                                Tóm Tắt Đơn Hàng
                                <span class="badge bg-secondary rounded-pill"
                                      th:text="${cart.totalItems} + (${cart.totalItems == 1} ? ' món' : ' món')">
                                </span>
                             </h4>
                        </div>
                        <div class="card-body">
                            <ul class="list-group list-group-flush mb-3">
                                <!-- Lặp qua các sản phẩm trong giỏ -->
                                <li th:each="item : ${cart.itemList}" class="list-group-item d-flex justify-content-between lh-sm order-summary-item px-0 py-2">
                                     <div class="d-flex align-items-center">
                                        <img th:src="@{${item?.imageUrl ?: '/img/placeholder.png'}}" th:alt="${item?.name}" class="img-thumbnail me-3">
                                        <div>
                                            <h6 class="my-0" th:text="${item?.name ?: '(Lỗi sản phẩm)'}">Product name</h6>
                                            <small class="text-muted" th:text="'SL: ' + ${item?.quantity ?: '?'}">SL: ?</small>
                                            <small class="d-block text-muted" th:if="${item.selectedSize != null}"
                                                 th:text="'Size: ' + ${item.selectedSize}"></small>
                                        </div>
                                    </div>
                                    <span class="text-muted text-nowrap"
                                          th:text="${item?.lineTotal != null ? #numbers.formatDecimal(item.lineTotal, 0, 'COMMA', 0, 'POINT') + ' ₫' : 'Lỗi'}">0 ₫</span>
                                </li>

                                <!-- Tạm tính -->
                                <li class="list-group-item d-flex justify-content-between px-0 py-2">
                                    <span>Tạm tính</span>
                                    <strong th:if="${cart?.totalAmount != null}"
                                            th:text="${#numbers.formatDecimal(cart.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' ₫'">0 ₫</strong>
                                    <span th:unless="${cart?.totalAmount != null}" class="text-danger">Lỗi</span>
                                </li>

                                <!-- Phí vận chuyển -->
                                <li class="list-group-item d-flex justify-content-between px-0 py-2">
                                    <span>Phí vận chuyển</span>
                                    <strong th:text="${#numbers.formatDecimal(25000, 0, 'COMMA', 0, 'POINT')} + ' ₫'">25.000 ₫</strong>
                                </li>

                                <!-- Tổng cộng -->
                                    <li class="list-group-item d-flex justify-content-between fw-bold fs-5 px-0 py-2 bg-light mt-2">
                                    <span>Tổng cộng</span>
                                    <span class="text-danger"
                                        th:text="${#numbers.formatDecimal(cart.totalAmount+25000, 0, 'COMMA', 0, 'POINT')}  + ' ₫'"> <!-- Chỉ hiển thị giá trị thô -->
                                    </span>
                                </li>

                            </ul>

                             <hr class="my-4">

                             <!-- Thông tin phương thức thanh toán -->
                             <h5 class="mb-3">Phương thức thanh toán</h5>
                              <div class="form-check p-3 border rounded bg-light">
                                <input id="codPayment" name="paymentMethodDisplay" type="radio" class="form-check-input" checked disabled>
                                <label class="form-check-label fw-medium" for="codPayment">
                                    <i class="bi bi-truck me-1"></i> Thanh toán khi nhận hàng (COD)
                                </label>
                                <small class="d-block text-muted">Trả tiền mặt trực tiếp cho nhân viên giao hàng khi bạn nhận được sản phẩm.</small>
                             </div>

                             <!-- ============================================ -->
                             <!-- === THÊM INPUT ẨN NÀY VÀO === -->
                             <!-- ============================================ -->
                             <input type="hidden" name="paymentMethod" value="COD" />
                             <!-- ============================================ -->

                             <!-- Hiển thị lỗi validation cho paymentMethod nếu cần -->
                             <div class="text-danger small mt-1" th:if="${#fields.hasErrors('paymentMethod')}" th:errors="*{paymentMethod}"></div>

                             <hr class="my-4">

                             <!-- Nút Đặt Hàng -->
                             <div class="d-grid">
                                 <button class="btn btn-primary btn-lg" type="submit">
                                     <i class="bi bi-bag-check-fill me-2"></i> Hoàn Tất Đặt Hàng
                                 </button>
                             </div>
                             

                        </div> <!-- End card-body Summary -->
                    </div> <!-- End card Summary -->
                </div> <!-- End Col Tóm tắt -->
            </div> <!-- End row -->

        </form> <!-- End Form Checkout -->

    </main>

    <!-- Include Footer -->
    <div th:replace="~{fragments/footer :: footer}"></div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Script xử lý validation của Bootstrap -->
    <script>
        // Example starter JavaScript for disabling form submissions if there are invalid fields
        (function () {
          'use strict'
          var forms = document.querySelectorAll('.needs-validation')
          Array.prototype.slice.call(forms)
            .forEach(function (form) {
              form.addEventListener('submit', function (event) {
                if (!form.checkValidity()) {
                  event.preventDefault()
                  event.stopPropagation()
                }
                form.classList.add('was-validated')
              }, false)
            })
        })()
    </script>

</body>
</html>